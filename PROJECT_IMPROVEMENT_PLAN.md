### 【統合改善計画】feelcycle-hub プロジェクト改善指示書

あなたはシニアソフトウェアエンジニアとして、`/Users/wataru/Projects/feelcycle-hub` プロジェクトの技術的負債の解消と、開発・運用プロセスの抜本的な改善をリードしてください。

#### プロジェクト概要

*   **目的:** FEELCYCLEユーザーのレッスン予約・管理体験を向上させるサポートサービス。
*   **技術スタック:** Next.js 14, AWS Lambda (Node.js), DynamoDB, AWS CDK, LINE API を活用したモノレポ構成。
*   **現状:** サービスは機能しているものの、手動運用が多く、不安定なスクレイピングに起因する技術的負債が蓄積している。

#### 主要課題

1.  **手動中心の運用プロセス:** CI/CDが未整備で、Lambdaのデプロイやバックアップが手動。これが非効率とミスの温床となっている。
2.  **場当たり的なテストと品質管理:** 体系的な自動テストがなく、品質保証が開発者個人の手作業に依存している。
3.  **不安定なスクレイピング処理:** エラーハンドリングや自動復旧の仕組みが不十分で、公式サイトの変更に弱い。
4.  **監視体制の不備:** 障害発生時の検知や原因調査が非効率。

---

### 改善ロードマップ

#### Phase 0: 開発・運用基盤の構築 (1-2週間)

*目的: 全ての改善活動の土台となる、自動化された開発・デプロイ基盤を確立する。*

**タスク0.1: CI/CDパイプラインの構築**
*   GitHub Actionsを導入し、`backend`のテスト、ビルド、デプロイを自動化する。
*   `main`ブランチへのマージをトリガーに、AWS CDK経由でLambda関数が自動デプロイされるワークフローを作成する。
*   これにより、手動での`lambda-deployment-*.zip`作成・管理を完全に廃止する。

**タスク0.2: テスト基盤の導入**
*   `backend`ワークスペースにテストフレームワーク`Vitest`を導入し、設定を完了させる。
*   既存の場当たり的なテストスクリプト（`test-*.js`など）を参考に、主要なロジック（例: `check-available-studios.ts`）に対するユニットテストを1つ作成し、テストの書き方の見本を示す。

#### Phase 1: 緊急対応と安定化 (1-2週間)

*目的: 散らかったプロジェクトを整理し、システムの安定性を即時的に向上させる。*

**タスク1.1: プロジェクト構造のクリーンアップ**
1.  `backend/`配下の`BACKUP_*`フォルダを分析し、最新3つ以外は削除（削除前にリスト作成）。
2.  `test-*.js`, `check-*.js`等のスクリプトを、新設する`backend/tests/`に統合・整理する。
3.  `package.json`の依存関係を見直し、不要なものを削除して統一する。
4.  最終的に以下のディレクトリ構造を目指す:
    ```
    backend/
    ├── src/           # メインソースコード
    ├── tests/         # Vitestによるテストコード
    ├── scripts/       # 手動実行用の運用スクリプト
    ├── infrastructure/ # AWS CDK設定
    └── docs/          # ドキュメント
    ```

**タスク1.2: エラーハンドリング強化**
*   `backend/src/services/real-feelcycle-scraper.ts`を改修し、指数バックオフ（Exponential Backoff）による最大3回のリトライ機能を実装する。
*   エラーを「ネットワークエラー」「パースエラー」「認証エラー」などに分類し、ログに出力する。

**タスク1.3: 自動復旧システムの実装**
*   `backend/src/services/auto-recovery.ts`を新規作成。
*   スクレイピングの連続失敗をDynamoDBで追跡し、3回連続で失敗した場合は、自動復旧ロジックを起動する。
*   復旧処理の実行時と結果を、LINE/Slack等で管理者に通知する。

#### Phase 2: 監視と運用の高度化 (2-3週間)

*目的: システムの状態を可視化し、問題発生時に迅速に対応できる体制を整える。*

**タスク2.1: 構造化ログシステムの導入**
*   `backend/src/utils/logger.ts`を作成し、JSON形式で構造化されたログを出力する`Logger`クラスを実装する。
*   プロジェクト全体の`console.log`を、この`Logger`クラス（`Logger.info()`, `Logger.error()`など）に置き換える。

**タスク2.2: CloudWatchダッシュボードの構築**
*   `backend/infrastructure/monitoring-stack.ts`を作成し、CDKで以下の項目を監視するダッシュボードを定義する。
    *   Lambda: 実行時間、エラー率、スロットル数
    *   API Gateway: レスポンス時間、4xx/5xxエラー数
    *   DynamoDB: 読み取り/書き込みキャパシティユニット
    *   ビジネスメトリクス: スクレイピング成功率

#### Phase 3: パフォーマンス最適化 (3-4週間)

*目的: ユーザー体験とコスト効率を向上させるための、将来的な改善。*

**タスク3.1: Lambdaパフォーマンスの最適化**
*   `backend/src/utils/performance.ts`を作成し、外部サービスへのコネクションを再利用するコネクションプーリングを実装する。
*   メモリ使用量を分析し、Lambdaのメモリ設定を最適化する。
*   コールドスタート対策として、Provisioned Concurrencyの導入を検討・評価する。

---

### 実行ガイドラインと成功指標

#### 必須チェック項目
*   **バージョン管理:** 変更前に必ず`git branch`を作成する。
*   **テスト:** 各タスク完了後、`npm run test`と`npm run build`が成功することを確認する。
*   **検証:** 本番環境への変更前に、可能であればステージング環境で検証する。
*   **バックアップ:** DynamoDBのテーブル構造など、重要なリソースを変更する前には必ずバックアップを取得する。

#### 成功指標
*   **スクレイピング成功率:** 99%以上
*   **API平均レスポンス時間:** 1.5秒以下
*   **システム稼働率:** 99.9%以上
*   **手動介入回数:** 月1回以下

#### 進捗報告形式
*   各タスク完了時に、以下の項目を簡潔に報告すること。
    *   実行した主要コマンド
    *   変更/作成/削除したファイル一覧
    *   テスト結果の概要
    *   次のタスクへの申し送り事項
